<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thank You - Download Your Guide</title>
    
    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-XXXXXXXXXX');
    </script>
    
    <!-- Facebook Pixel -->
    <script>
      !function(f,b,e,v,n,t,s)
      {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
      n.callMethod.apply(n,arguments):n.queue.push(arguments)};
      if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
      n.queue=[];t=b.createElement(e);t.async=!0;
      t.src=v;s=b.getElementsByTagName(e)[0];
      s.parentNode.insertBefore(t,s)}(window,document,'script',
      'https://connect.facebook.net/en_US/fbevents.js');
      fbq('init', 'XXXXXXXXXXXXXXXXX');
      fbq('track', 'PageView');
    </script>
    
    <style>
        :root {
            --purple: #522888;
            --gold: #BF9553;
            --dark-purple: #401F6B;
            --light-gold: #D4AF5A;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, var(--purple), var(--dark-purple));
            min-height: 100vh;
            color: white;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .success-message {
            text-align: center;
            margin-bottom: 3rem;
        }
        
        .download-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 2rem;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 3rem;
        }
        
        .download-button {
            display: inline-block;
            background: var(--gold);
            color: var(--dark-purple);
            padding: 1rem 2rem;
            border-radius: 5px;
            text-decoration: none;
            font-weight: bold;
            font-size: 1.2rem;
            margin-top: 1rem;
        }
        
        .download-button:hover {
            background: var(--light-gold);
        }
        
        .upsell-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 2rem;
            border-radius: 10px;
            margin-bottom: 2rem;
        }
        
        .special-offer {
            text-align: center;
            margin-bottom: 1.5rem;
        }
        
        .offer-price {
            font-size: 2rem;
            color: var(--gold);
            text-decoration: line-through;
            opacity: 0.7;
        }
        
        .sale-price {
            font-size: 3rem;
            color: var(--gold);
            font-weight: bold;
        }
        
        .upsell-button {
            display: inline-block;
            background: var(--gold);
            color: var(--dark-purple);
            padding: 1rem 2rem;
            border-radius: 5px;
            text-decoration: none;
            font-weight: bold;
            font-size: 1.2rem;
            margin-top: 1rem;
            cursor: pointer;
        }
        
        .upsell-button:hover {
            background: var(--light-gold);
        }
        
        .guarantee {
            text-align: center;
            margin-top: 2rem;
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .loading {
            display: none;
            text-align: center;
            margin-top: 1rem;
        }
        
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--gold);
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="success-message">
            <h1>Thank You for Your Purchase!</h1>
            <p>Your payment has been successfully processed.</p>
        </div>
        
        <div class="download-section">
            <h2>Download Your Travel Planner</h2>
            <p>Click the button below to download "The Ultimate Budget Travel Planner"</p>
            <a href="#" id="download-link" class="download-button">Download PDF Now</a>
            <p style="margin-top: 1rem; font-size: 0.9rem;">
                Download available for 24 hours (3 downloads max)
            </p>
            
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>Preparing your download...</p>
            </div>
        </div>
        
        <div class="upsell-section">
            <div class="special-offer">
                <h2>Special One-Time Offer!</h2>
                <p>Since you're already saving with our strategies, we're offering you exclusive access to:</p>
                <h3>"The Secret Travel Technique Bundle"</h3>
                <p>Our most advanced travel hacking techniques that typically save $5,000+ per luxury trip</p>
                
                <div style="margin: 2rem 0;">
                    <span class="offer-price">$277</span>
                    <span class="sale-price">$77</span>
                    <p style="color: var(--gold);">Limited to this purchase only</p>
                </div>
                
                <button id="upsell-button" class="upsell-button">
                    Yes! Add This To My Order
                </button>
                
                <div id="upsell-loading" class="loading">
                    <div class="spinner"></div>
                    <p>Processing your order...</p>
                </div>
                
                <p style="margin-top: 1rem;">
                    Includes: Advanced Hotel Negotiation Scripts, VIP Treatment Guarantees, 
                    Private Jet Repositioning Flights, and Exclusive Luxury Experience Access
                </p>
            </div>
        </div>
        
        <div class="guarantee">
            <p>100% Money-Back Guarantee â€¢ Questions? Email support@valueguides.co</p>
        </div>
    </div>
    
    <script>
        // Get session ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get('session_id');
        const isUpsell = urlParams.get('upsell') === 'true';
        
        // Show loading state
        document.getElementById('loading').style.display = 'block';
        
        // Function to verify session and get download link
        async function verifySessionAndGetDownloadLink() {
            if (!sessionId) {
                window.location.href = '/';
                return;
            }
            
            try {
                const response = await fetch(`/verify-session?sessionId=${sessionId}`);
                const data = await response.json();
                
                // Hide loading state
                document.getElementById('loading').style.display = 'none';
                
                if (data.verified) {
                    // Set download link
                    document.getElementById('download-link').href = data.downloadUrl;
                    
                    // If this is an upsell confirmation, show a specific message
                    if (isUpsell) {
                        document.querySelector('.success-message h1').textContent = 'Upsell Successfully Purchased!';
                        document.querySelector('.success-message p').textContent = 'Your Secret Travel Technique Bundle is ready to download.';
                    }
                    
                    // Track successful purchase
                    gtag('event', 'purchase', {
                        'transaction_id': sessionId,
                        'currency': 'USD',
                        'value': isUpsell ? 77.00 : 17.99,
                        'items': [{
                            'id': isUpsell ? 'travel-technique-bundle' : 'travel-planner',
                            'name': isUpsell ? 'Secret Travel Technique Bundle' : 'The Ultimate Budget Travel Planner',
                            'price': isUpsell ? 77.00 : 17.99,
                            'quantity': 1
                        }]
                    });
                    
                    fbq('track', 'Purchase', {
                        value: isUpsell ? 77.00 : 17.99,
                        currency: 'USD'
                    });
                } else {
                    // If verification failed, redirect to error page
                    window.location.href = '/error.html?message=Payment verification failed&suggestion=Please contact support if you believe this is an error.';
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loading').style.display = 'none';
                window.location.href = '/error.html?message=An error occurred&suggestion=Please try again or contact support.';
            }
        }
        
        // Call verification function
        verifySessionAndGetDownloadLink();
        
        // Handle upsell click
        document.getElementById('upsell-button').addEventListener('click', async function() {
            // Show loading state
            document.getElementById('upsell-loading').style.display = 'block';
            this.disabled = true;
            
            try {
                // Track upsell click
                gtag('event', 'add_to_cart', {
                    'items': [{
                        'id': 'travel-technique-bundle',
                        'name': 'Secret Travel Technique Bundle',
                        'price': 77.00,
                        'quantity': 1
                    }]
                });
                fbq('track', 'AddToCart');
                
                // Create upsell checkout session
                const response = await fetch('/create-upsell-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ originalOrderId: sessionId })
                });
                
                const data = await response.json();
                
                if (data.checkoutUrl) {
                    window.location.href = data.checkoutUrl;
                } else {
                    throw new Error('Could not create upsell checkout session');
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('upsell-loading').style.display = 'none';
                this.disabled = false;
                alert('An error occurred. Please try again later.');
            }
        });
        
        // Track download clicks
        document.getElementById('download-link').addEventListener('click', function() {
            gtag('event', 'download', {
                'event_category': 'engagement',
                'event_label': 'pdf_download'
            });
        });
    </script>
</body>
</html>